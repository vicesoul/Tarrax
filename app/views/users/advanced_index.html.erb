
<div>
  <% form_for @search, :url => account_advanced_users_path do |f| %>

    <div>
    Name: <%= f.text_field :name_like %>
    <%= f.submit "Search" %>
  <% end %>

  <% if @users && @users.present? %>
    <!-- Don't modify if you expect the correct pagination when using sort -->
    <%= pagination = will_paginate(@users, :style=>"margin-top: 1em;") %>
      <table border="1" class="table table-striped ">
        <thead>
          <tr>
            <td width="100px">
              <%= t 'table_headings.id', 'ID' %><br />
              <input type="checkbox" value="" />Check All
            </td>
            <td width="200px"><%= sortable_for_searchlogic('name', (t 'table_headings.name', 'Name')) %></td>
            <td><%= t 'table_headings.account', 'Account' %></td>
            <td><%= sortable_for_searchlogic('job_number', (t 'table_headings.job_number', 'Job Number'), 'user_account_associations_sort_by_custom') %></td>
            <td><%= sortable_for_searchlogic('id', (t 'table_headings.job_position', 'Job Position'), 'user_account_associations_sort_by_job_position') %></td>
            <td><%= sortable_for_searchlogic('external', (t 'table_headings.is_external', 'Is External'), 'user_account_associations_sort_by_custom') %></td>
            <td><%= sortable_for_searchlogic('id', (t 'table_headings.tags', 'Tags'), 'user_account_associations_sort_by_tags') %></td>
            <td><%= sortable_for_searchlogic('source', (t 'table_headings.source', 'Source'), 'user_account_associations_sort_by_custom') %></td>
          </tr>
        </thead>
        <tbody>
          <% 
            associated_ids = (params[:search] && params[:search][:user_account_associations_account_id_in]) ? params[:search][:user_account_associations_account_id_in] : [params[:account_id]]
          %>
          <% @users.each do |user| %>
            <%
               user_account_associations = user.user_account_associations.filter_by_account_id(associated_ids) 
               user_account_associations.delete_if{|u| u.account.root_account?} if user_account_associations.size >= 2
            %>
              <% user_account_associations.each_with_index do |u, i| %>
            <tr>
              <% if i== 0 %>
                <td rowspan="<%= user_account_associations.size %>">
                  <input type="checkbox" value="<%= user.id %>" />
                </td>
                <td rowspan="<%= user_account_associations.size%>"><%= user.name %></td>
              <% end %>
                <td><%= u.account.name %></td>
                <td><%= u.job_number %></td>
                <td><%= u.job_position.try(:name) %></td>
                <td><%= u.external == true ? 'yes' : 'no' %></td>
                <td><%= u.tag_list %></td>
                <td><%= u.source %></td>
            </tr>
              <% end %>
          <% end %>
        </tbody>
      </table>
    <%= pagination %>
  <% end %>
</div>
